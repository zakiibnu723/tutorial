<!DOCTYPE html>  
<html lang="en">  
<head>  
    <title>three.js ar - hit test with shadows</title>  
    <meta charset="utf-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">  
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }
        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }
        .sidenav a:hover {
            color: #f1f1f1;
        }
        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        #place-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            display: none;
            z-index: 100;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>  
</head>  
<body>  
<div id="content">  
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a class="ar-object" id="yelow-sofa" href="#">Yellow Sofa</a>
        <a class="ar-object" id="blue-chair" href="#">Blue Chair</a>
        <a class="ar-object" id="arm-chair" href="#">Arm Chair</a>
        <a class="ar-object" id="sofa1" href="#">Sofa 1</a>
        <a class="ar-object" id="sofa-2b" href="#">Sofa 2B</a>
        <a class="ar-object" id="uploads_files_3063858_Lounge+Chair+ITF" href="#">Lounge Chair</a>
        <a class="ar-object" id="Memosofa" href="#">Memosofa</a>
        <a class="ar-object" id="ImageToStl.com_sofa" href="#">Sofa GLB</a>
    </div>
  
    <div id="container"></div>  
    <span style="font-size:30px;cursor:pointer;position: absolute;z-index:100;padding:10px;" onclick="openNav()">&#9776; open</span>  
    <button type="button" id="place-button">PLACE</button>  
</div>  
  
<script>  
    function openNav() {  
        document.getElementById("mySidenav").style.width = "250px";  
    }  
    function closeNav() {  
        document.getElementById("mySidenav").style.width = "0";  
    }  
</script>  
  
<script type="module">  
    import * as THREE from './build/three.module.js';  
    import { ARButton } from './jsm/webxr/ARButton.js';  
    import { VRButton } from './jsm/webxr/VRButton.js';  
    import { OrbitControls } from './jsm/controls/OrbitControls.js';  
    import { GLTFLoader } from './jsm/loaders/GLTFLoader.js'; 
    import { OBJLoader } from './jsm/loaders/OBJLoader.js';   
    import { RGBELoader } from './jsm/loaders/RGBELoader.js';  
    import { RoughnessMipmapper } from './jsm/utils/RoughnessMipmapper.js';  
  
    let container;  
    let camera, scene, renderer;  
    let controller;  
    let reticle, pmremGenerator, current_object, controls, isAR, envmap;  
    let hitTestSource = null;  
    let hitTestSourceRequested = false;
    let directionalLight, hemisphericLight;
  
    init();  
    animate();  
  
    $(".ar-object").click(function(){  
        if(current_object != null){  
            scene.remove(current_object);  
        }  
        loadModel($(this).attr("id"));  
    });  
  
    $("#ARButton").click(function(){  
        current_object.visible = false;  
        isAR = true;  
    });  
  
    $("#VRButton").click(function(){  
        scene.background = envmap;  
        scene.position.z = -2;  
    });  
  
    $("#place-button").click(function(){  
        arPlace();  
    });  
  
    function arPlace(){  
        if (reticle.visible) {  
            current_object.position.setFromMatrixPosition(reticle.matrix);  
            current_object.visible = true;  
        }  
    }  
  
    function loadModel(model) {  
        new RGBELoader()  
            .setDataType(THREE.UnsignedByteType)  
            .setPath('textures/')  
            .load('photo_studio_01_1k.hdr', function (texture) {  
                envmap = pmremGenerator.fromEquirectangular(texture).texture;  
                scene.environment = envmap;  
                texture.dispose();  
                pmremGenerator.dispose();  
                render();  

                var loader = new GLTFLoader().setPath('3d/');  
                loader.load(model + ".glb", function (glb) {  
                    current_object = glb.scene;                 
                    current_object.traverse(n => {  
                        if (n.isMesh) {  
                            n.castShadow = true;
                            n.receiveShadow = true;
                            if (n.material.map) n.material.map.anisotropy = 16;
                        }  
                    });  

                    scene.add(current_object);  
                    arPlace();  

                    var box = new THREE.Box3();  
                    box.setFromObject(current_object);  
                    box.center(controls.target);  

                    controls.update();  
                    render();  
                });  
            });  
    }  

    function init() {    
        container = document.createElement('div');    
        document.getElementById("container").appendChild(container);    
        
        scene = new THREE.Scene();    
        window.scene = scene;    
        
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.001, 200);    
        
        // Enhanced Ground Plane for better shadow reception
        const groundGeometry = new THREE.PlaneGeometry(10, 10);  
        const groundMaterial = new THREE.ShadowMaterial({ 
            opacity: 0.3,
            transparent: true,
        }); 
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);  
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        // Enhanced Lighting Setup
        hemisphericLight = new THREE.HemisphereLight(0xffa500, 0x808080, 0.5);
        scene.add(hemisphericLight);    
        
        directionalLight = new THREE.DirectionalLight(0xffffff, 4);
        directionalLight.position.set(10, 10, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.bias = -0.0001;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 0.1;
        directionalLight.shadow.camera.far = 50;
        directionalLight.shadow.camera.left = -10;
        directionalLight.shadow.camera.right = 10;
        directionalLight.shadow.camera.top = 10;
        directionalLight.shadow.camera.bottom = -10;
        scene.add(directionalLight);
        
        // Enhanced Renderer Setup   
        renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            alpha: true,
            logarithmicDepthBuffer: true
        });    
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1;
        renderer.setPixelRatio(window.devicePixelRatio);    
        renderer.setSize(window.innerWidth, window.innerHeight);    
        renderer.xr.enabled = true;    
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowMap.autoUpdate = true;
        container.appendChild(renderer.domElement);    
        
        pmremGenerator = new THREE.PMREMGenerator(renderer);    
        pmremGenerator.compileEquirectangularShader();    
        
        controls = new OrbitControls(camera, renderer.domElement);    
        controls.addEventListener('change', render);    
        controls.minDistance = 2;    
        controls.maxDistance = 10;    
        controls.target.set(0, 0, -0.2);    
        controls.enableDamping = true;    
        controls.dampingFactor = 0.05;    
        
        document.body.appendChild(VRButton.createButton(renderer));    
        
        let options = {    
            requiredFeatures: ['hit-test'],    
            optionalFeatures: ['dom-overlay'],    
        }    
        
        options.domOverlay = { root: document.getElementById('content') };    
        
        document.body.appendChild(ARButton.createButton(renderer, options));    
        
        reticle = new THREE.Mesh(    
            new THREE.RingBufferGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),    
            new THREE.MeshBasicMaterial()    
        );    
        reticle.matrixAutoUpdate = false;    
        reticle.visible = false;    
        scene.add(reticle);    
        
        window.addEventListener('resize', onWindowResize, false);    
    }  

    function onWindowResize() {  
        camera.aspect = window.innerWidth / window.innerHeight;  
        camera.updateProjectionMatrix();  
        renderer.setSize(window.innerWidth, window.innerHeight);  
    }  
  
    function animate() {  
        renderer.setAnimationLoop(render);
        requestAnimationFrame(animate);
        controls.update();
    }  
  
    function render(timestamp, frame) {  
        if (frame && isAR) {  
            const referenceSpace = renderer.xr.getReferenceSpace();  
            const session = renderer.xr.getSession();  
  
            if (hitTestSourceRequested === false) {  
                session.requestReferenceSpace('viewer').then(function(referenceSpace) {  
                    session.requestHitTestSource({ space: referenceSpace }).then(function(source) {  
                        hitTestSource = source;  
                    });  
                });  
  
                session.addEventListener('end', function() {  
                    hitTestSourceRequested = false;  
                    hitTestSource = null;  
                    isAR = false;  
                    reticle.visible = false;  
  
                    var box = new THREE.Box3();  
                    box.setFromObject(current_object);  
                    box.center(controls.target);  
  
                    document.getElementById("place-button").style.display = "none";  
                });  
  
                hitTestSourceRequested = true;  
            }  
  
            if (hitTestSource) {  
                const hitTestResults = frame.getHitTestResults(hitTestSource);  
  
                if (hitTestResults.length) {  
                    const hit = hitTestResults[0];  
                    document.getElementById("place-button").style.display = "block";  
                    reticle.visible = true;  
                    reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);  

                    // Update directional light position relative to camera in AR
                    if (camera) {
                        const cameraPosition = camera.position;
                        directionalLight.position.set(
                            cameraPosition.x + 10,
                            cameraPosition.y + 10,
                            cameraPosition.z + 10
                        );
                        directionalLight.target.position.set(
                            cameraPosition.x,
                            cameraPosition.y,
                            cameraPosition.z
                        );
                        directionalLight.target.updateMatrixWorld();
                    }
                } else {  
                    reticle.visible = false;  
                    document.getElementById("place-button").style.display = "none";  
                }  
            }  
        }  
  
        renderer.render(scene, camera);  
    }  
</script>  
</body>  
</html>
